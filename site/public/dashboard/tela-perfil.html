<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Perfil</title>
    <link rel="stylesheet" href="../css/dashboard/tela-perffil.css">
    <script src="../js/sessao.js"></script>
</head>

<body>

    <aside class="sidebar">
        <img src="" alt="">

        <div class="usuario-info">
            <div class="foto-perfil-mini" id="fotoMini" style="background-image: url('../assets/imgs/usuario.png')">
            </div>
            <span class="nome-usuario" id="nomeMini">Olá Usuário!</span>
        </div>

        <nav class="menu">
            <a href="../dashboard/tela-perfil.html" class="ativo">Perfil</a>
            <a href="../dashboard/tela-questoes.html">DesbravaQuiz</a>
            <a href="../dashboard/tela-desempenho.html">Desempenho</a>
        </nav>

        <div class="btn-sair">
            <a href="../index.html" onclick="limparSessao()">SAIR</a>
        </div>
    </aside>

    <main class="conteudo">
        <h1 class="titulo-pagina" id="tituloPerfil">Seja bem-vindo!</h1>

        <div class="perfil-container">

            <div class="perfil-foto">
                <div class="foto-grande" id="fotoGrande" style="background-image: url('/assets/imgs/usuario.png')">
                </div>
                <button class="btn-upload" onclick="document.getElementById('input_file').click()">
                    Enviar Foto
                </button>
                <input type="file" id="input_file" accept="image/*" style="display: none">
            </div>

            <div class="perfil-dados">

                <div class="subbloco-pessoal" id="dadosPessoais">
                    <h3>Dados Pessoais</h3>
                    <p><strong>Nome:</strong> <span id="nomeUsuario">-</span></p>
                    <p><strong>Idade:</strong> <span id="idadeUsuario">-</span></p>
                    <p><strong>E-mail:</strong> <span id="emailUsuario">-</span></p>
                </div>

                <div class="subbloco" id="dadosDesbravador">
                    <h3>Dados do Desbravador</h3>
                    <p><strong>Membro:</strong> <span id="tipoMembro">-</span></p>
                    <p><strong>Cargo:</strong> <span id="cargoUsuario">-</span></p>
                    <p><strong>Unidade:</strong> <span id="unidadeUsuario">-</span></p>
                    <p><strong>Classe:</strong> <span id="classeUsuario">-</span></p>
                </div>

            </div>

        </div>

        <h2 class="titulo-especialidade">Especialidades</h2>
        <div class="cards-especialidades" id="card-esp">
        </div>

    </main>

</body>

<script>
    const tiposMembro = { 1: "Desbravador", 2: "Diretoria", 3: "Visitante" };
    const cargos = {
        1: "Diretor", 2: "D. Associado", 3: "Capelão", 4: "Secretário", 5: "Tesoureiro",
        6: "Conselheiro", 7: "Instrutor", 8: "Coord. Atividades", 9: "Logística",
        10: "Comunicação", 11: "N/A"
    };
    const unidades = { 1: "Diretoria", 2: "Guepardos", 3: "Leões", 4: "Panteras", 5: "Onças", 6: "N/A" };
    const classes = { 1: "Amigo", 2: "Companheiro", 3: "Pesquisador", 4: "Pioneiro", 5: "Excursionista", 6: "Guia", 7: "N/A" };

    document.addEventListener("DOMContentLoaded", function () {
        validarSessao();
        carregarPerfilNaTela();
        configurarUpload();
    });

    function validarSessao() {
        const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) {
            window.location = "../login.html";
            return;
        }
        console.log("Sessão válida:", usuario);
    }

    function carregarPerfilNaTela() {
        const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) return;

        document.getElementById("nomeMini").innerText = `Olá ${usuario.nome ? usuario.nome.split(" ")[0] : "Usuário"}!`;

        const caminhoFoto = usuario.imagem_perfil ? `/assets/${usuario.imagem_perfil}` : `/assets/imgs/usuario.png`;
        document.getElementById("fotoGrande").style.backgroundImage = `url('${caminhoFoto}')`;
        document.getElementById("fotoMini").style.backgroundImage = `url('${caminhoFoto}')`;

        document.getElementById("nomeUsuario").innerText = usuario.nome || "-";
        document.getElementById("emailUsuario").innerText = usuario.email || "-";
        document.getElementById("idadeUsuario").innerText = calcularIdade(usuario.dt_nasc);

        document.getElementById("tipoMembro").innerText = tiposMembro[usuario.tipo_membro] || "-";
        document.getElementById("cargoUsuario").innerText = cargos[usuario.id_cargo] || "-";
        document.getElementById("unidadeUsuario").innerText = unidades[usuario.id_unidade] || "-";
        document.getElementById("classeUsuario").innerText = classes[usuario.id_classe] || "-";

        fetch(`/especialidade/listar/${usuario.id}`)
            .then(res => res.json())
            .then(especialidades => {
                const dados = JSON.parse(sessionStorage.getItem("USUARIO_DADOS")) || usuario;
                dados.especialidades = especialidades;
                sessionStorage.setItem("USUARIO_DADOS", JSON.stringify(dados));
                carregarEspecialidades();
            })
            .catch(err => {
                console.error("Erro ao buscar especialidades:", err);
                carregarEspecialidades();
            });
    }

    function carregarEspecialidades() {
        const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) return;

        const cardsContainer = document.getElementById("card-esp");
        if (!cardsContainer) return;

        cardsContainer.innerHTML = "";

        const especialidades = usuario.especialidades || [];

        if (especialidades.length === 0) {
            cardsContainer.innerHTML = `<p class="sem-especialidade">Nenhuma especialidade conquistada ainda.</p>`;
            return;
        }

        especialidades.forEach(e => {
            let icone = "padrao.png";

            switch (e.nome_especialidade) {
                case "Ordem Unida": icone = "ordem-unida.webp"; break;
                case "Nós e Amarras": icone = "nos-amarras.webp"; break;
                case "Acampamento": icone = "acampamento.webp"; break;
                case "Cidadania Cristã": icone = "missionarias.png"; break;
                case "Intercessor": icone = "missionarias2.png"; break;
                case "Evangelismo": icone = "missionarias2.webp"; break;
                case "Astronomia": icone = "astronomia.png"; break;
                case "Árvores": icone = "arvores.webp"; break;
                case "Répteis": icone = "repteis.webp"; break;
            }

            const card = document.createElement("div");
            card.classList.add("card-esp");
            card.innerHTML = `
                <img src="../assets/icones/dashboard/${icone}" alt="${e.nome_especialidade}">
                <span>${e.nome_especialidade}</span>
            `;
            cardsContainer.appendChild(card);
        });
    }

    function calcularIdade(dataNasc) {
        if (!dataNasc) return "-";
        const hoje = new Date();
        const nasc = new Date(dataNasc);
        let idade = hoje.getFullYear() - nasc.getFullYear();
        const m = hoje.getMonth() - nasc.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
        return idade;
    }

    function configurarUpload() {
        const inputFile = document.getElementById("input_file");
        inputFile.addEventListener("change", function () {
            const arquivo = this.files[0];
            if (!arquivo) return;

            const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
            if (!usuario || !usuario.id) return;

            const formData = new FormData();
            formData.append("foto", arquivo);
            formData.append("idUsuario", usuario.id);

            fetch("/usuarios/salvarFoto", { method: "POST", body: formData })
                .then(res => res.json())
                .then(json => {
                    if (!json.success) return alert("Erro ao enviar foto");
                    const caminho = `/assets/${json.nomeArquivo}`;
                    document.getElementById("fotoGrande").style.backgroundImage = `url('${caminho}')`;
                    document.getElementById("fotoMini").style.backgroundImage = `url('${caminho}')`;
                    usuario.imagem_perfil = json.nomeArquivo;
                    sessionStorage.setItem("USUARIO_DADOS", JSON.stringify(usuario));
                })
                .catch(err => console.error("Erro no fetch upload:", err));
        });
    }

    function limparSessao() {
        sessionStorage.clear();
        window.location = "../login.html";
    }

</script>