<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desempenho - Castor Family</title>
    <link rel="stylesheet" href="../css/dashboard/tela-desempenho.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="Desempenho()">

    <aside class="sidebar">
        <img src="" alt="">
        <div class="usuario-info">
            <div class="foto-perfil-mini" id="fotoMini" style="background-image: url('../assets/imgs/usuario.png')">
            </div>
            <span class="nome-usuario" id="nomeMini">Usuário</span>
        </div>

        <nav class="menu">
            <a href="../dashboard/tela-perfil.html">Perfil</a>
            <a href="../dashboard/tela-questoes.html">DesbravaQuiz</a>
            <a href="../dashboard/tela-desempenho.html" class="ativo">Desempenho</a>
        </nav>

        <div class="btn-sair">
            <a href="../index.html" onclick="limparSessao()">SAIR</a>
        </div>
    </aside>

    <main class="conteudo">

        <h1 class="titulo-pagina">Desempenho</h1>

        <div class="kpi-container">
            <div class="kpi">
                <h3>Última Especialidade Conquistada</h3>
                <span id="kpi1">-</span>
            </div>
            <div class="kpi">
                <h3>Total de Quizzes Jogados</h3>
                <span id="kpi2">-</span>
            </div>
            <div class="kpi">
                <h3>Média Geral de Acertos (%)</h3>
                <span id="kpi3">-</span>
            </div>
            <div class="kpi">
                <h3>Acertos do Último Quiz</h3>
                <span id="kpi4">-</span>
            </div>
        </div>

        <div class="graficos-lado">
            <div class="grafico-container">
                <h2 class="grafico-titulo">Evolução de Acertos</h2>
                <canvas id="graficoLinha"></canvas>
            </div>

            <div class="grafico-container">
                <h2 class="grafico-titulo">Quizzes Jogados</h2>
                <canvas id="graficoRosquinha"></canvas>
            </div>
        </div>

    </main>

    <script src="../js/desempenho.js"></script>

</body>

</html>

<script>

    function Desempenho() {
        carregarUsuario();
        carregarDesempenho();
    }

    function carregarUsuario() {
        var usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) {
            console.error("Usuário não encontrado no sessionStorage!");
            return;
        }

        var nomeMini = document.getElementById("nomeMini");
        var fotoMini = document.getElementById("fotoMini");

        if (nomeMini && usuario.nome) {
            var primeiroNome = usuario.nome.split(" ")[0];
            nomeMini.innerText = "Olá " + primeiroNome + "!";
        }

        var caminhoFoto = usuario.imagem_perfil ? "/assets/" + usuario.imagem_perfil : "/assets/imgs/usuario.png";
        fotoMini.style.backgroundImage = "url('" + caminhoFoto + "')";
    }

    function salvarDadosDesempenho(ultimoQuiz, resumo, todosResultados) {
        sessionStorage.setItem("DESENVOLVIMENTO_ULTIMO_QUIZ", JSON.stringify(ultimoQuiz));
        sessionStorage.setItem("DESENVOLVIMENTO_RESUMO", JSON.stringify(resumo));
        sessionStorage.setItem("DESENVOLVIMENTO_TODOS_RESULTADOS", JSON.stringify(todosResultados));
    }

    function obterDadosDesempenho() {
        var ultimoQuiz = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_ULTIMO_QUIZ"));
        var resumo = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_RESUMO"));
        var todosResultados = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_TODOS_RESULTADOS"));
        return { ultimoQuiz: ultimoQuiz, resumo: resumo, todosResultados: todosResultados };
    }

    async function carregarDesempenho() {
        var usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) {
            console.error("Usuário não encontrado no sessionStorage!");
            return;
        }

        try {
            var ultimoQuizRes = await fetch("/dadosQuiz/ultimo/" + usuario.id);
            var resumoRes = await fetch("/dadosQuiz/resumo/" + usuario.id);
            var todosResultadosRes = await fetch("/dadosQuiz/listar/" + usuario.id);

            var ultimoQuiz = await ultimoQuizRes.json();
            var resumo = await resumoRes.json();
            var todosResultados = await todosResultadosRes.json();

            salvarDadosDesempenho(ultimoQuiz, resumo, todosResultados);

            var quizzesGanhos = [];
            for (var i = 0; i < todosResultados.length; i++) {
                if (Number(todosResultados[i].qtd_acertos) >= 3) {
                    quizzesGanhos.push(todosResultados[i]);
                }
            }

            var ultEspecialidade = "-";
            if (quizzesGanhos.length > 0) {
                ultEspecialidade = quizzesGanhos[quizzesGanhos.length - 1].nome_especialidade;
            }
            document.getElementById("kpi1").innerText = ultEspecialidade;

            document.getElementById("kpi2").innerText = todosResultados.length;

            var somaAcertos = 0;
            var somaPerguntas = 0;
            for (var i = 0; i < todosResultados.length; i++) {
                somaAcertos += Number(todosResultados[i].qtd_acertos);
                somaPerguntas += Number(todosResultados[i].total_perguntas);
            }
            var media = somaPerguntas > 0 ? ((somaAcertos / somaPerguntas) * 100).toFixed(1) : "0.0";
            document.getElementById("kpi3").innerText = media + "%";

            document.getElementById("kpi4").innerText = ultimoQuiz ? (ultimoQuiz.qtd_acertos + "/" + ultimoQuiz.total_perguntas) : "-";

            var ctxLinha = document.getElementById("graficoLinha").getContext("2d");
            if (window.graficoLinha instanceof Chart) {
                window.graficoLinha.destroy();
            }

            var coresOficiais = {
                "Ordem Unida": "#FF7F50",
                "Nós e Amarras": "#36A2EB",
                "Acampamento": "#4BC0C0"
            };

            var especialidadesJogadas = [];
            for (var i = 0; i < todosResultados.length; i++) {
                var esp = todosResultados[i].nome_especialidade;
                if (especialidadesJogadas.indexOf(esp) === -1) {
                    especialidadesJogadas.push(esp);
                }
            }

            var datasetsLinha = [];
            for (var i = 0; i < especialidadesJogadas.length; i++) {
                var esp = especialidadesJogadas[i];
                var resultadosEsp = [];
                for (var j = 0; j < todosResultados.length; j++) {
                    if (todosResultados[j].nome_especialidade === esp) {
                        resultadosEsp.push(todosResultados[j]);
                    }
                }
    
                resultadosEsp.sort(function (a, b) {
                    return new Date(a.data_inclusao) - new Date(b.data_inclusao);
                });

                var dataEsp = [];
                for (var k = 0; k < resultadosEsp.length; k++) {
                    dataEsp.push(Number(resultadosEsp[k].qtd_acertos));
                }

                var cor = coresOficiais[esp] ? coresOficiais[esp] : "#9966FF";

                datasetsLinha.push({
                    label: esp,
                    data: dataEsp,
                    borderColor: cor,
                    backgroundColor: "rgba(0,0,0,0)",
                    tension: 0.4,
                    fill: false,
                    pointBackgroundColor: cor,
                    pointBorderColor: cor,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    pointStyle: "rectRounded",
                    borderWidth: 3,
                    hoverBorderWidth: 4
                });
            }

            var maxQuizzes = 0;
            for (var i = 0; i < especialidadesJogadas.length; i++) {
                var count = 0;
                for (var j = 0; j < todosResultados.length; j++) {
                    if (todosResultados[j].nome_especialidade === especialidadesJogadas[i]) count++;
                }
                if (count > maxQuizzes) maxQuizzes = count;
            }

            var labelsLinha = [];
            for (var i = 0; i < maxQuizzes; i++) {
                labelsLinha.push("Quiz " + (i + 1));
            }

            window.graficoLinha = new Chart(ctxLinha, {
                type: "line",
                data: { labels: labelsLinha, datasets: datasetsLinha },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: "#ffffff", font: { size: 14, weight: "bold" }, usePointStyle: true, pointStyleWidth: 12 }
                        },
                        tooltip: { mode: "index", intersect: false, backgroundColor: "#222", titleColor: "#fff", bodyColor: "#fff", titleFont: { weight: "bold", size: 14 }, bodyFont: { size: 13 }, padding: 10, cornerRadius: 6, boxPadding: 4 }
                    },
                    interaction: { mode: "nearest", intersect: false },
                    scales: {
                        x: { title: { display: true, text: "Quizzes Jogados", color: "#ffffff", font: { size: 16, weight: "bold" } }, ticks: { color: "#ffffff", font: { size: 13 } }, grid: { color: "#444", borderDash: [3, 3] } },
                        y: { title: { display: true, text: "Acertos", color: "#ffffff", font: { size: 16, weight: "bold" } }, ticks: { color: "#ffffff", font: { size: 13 }, stepSize: 1 }, grid: { color: "#444", borderDash: [3, 3] }, beginAtZero: true, max: 10 }
                    }
                }
            });


            var ctxRosq = document.getElementById("graficoRosquinha").getContext("2d");
            if (window.graficoRosquinha instanceof Chart) window.graficoRosquinha.destroy();

            var labelsRosq = [];
            var dataRosq = [];
            var coresRosq = [];
            for (var i = 0; i < resumo.length; i++) {
                labelsRosq.push(resumo[i].nome_especialidade);
                dataRosq.push(Number(resumo[i].quizzes_jogados));
                coresRosq.push(coresOficiais[resumo[i].nome_especialidade] ? coresOficiais[resumo[i].nome_especialidade] : "#9966FF");
            }

            window.graficoRosquinha = new Chart(ctxRosq, {
                type: "doughnut",
                data: { labels: labelsRosq, datasets: [{ data: dataRosq, backgroundColor: coresRosq, borderColor: "#121212", borderWidth: 3, hoverOffset: 10, hoverBorderColor: "#ffffff" }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "50%",
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: { color: "#ffffff", font: { size: 14, weight: "bold" }, usePointStyle: true, pointStyle: "circle", pointStyleWidth: 14 }
                        },
                        tooltip: {
                            backgroundColor: "#222",
                            titleColor: "#fff",
                            bodyColor: "#fff",
                            titleFont: { weight: "bold", size: 14 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            cornerRadius: 6,
                            callbacks: {
                                label: function (context) {
                                    return context.label + ": " + context.raw + " quizzes";
                                }
                            }
                        }
                    }
                }
            });

        } catch (erro) {
            console.error("Erro ao carregar desempenho:", erro);
        }
    }
</script>