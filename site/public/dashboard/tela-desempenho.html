<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desempenho - Castor Family</title>
    <link rel="stylesheet" href="../css/dashboard/tela-desempenho.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="initDesempenho()">

    <aside class="sidebar">
        <img src="" alt="">
        <div class="usuario-info">
            <div class="foto-perfil-mini" id="fotoMini" style="background-image: url('../assets/imgs/usuario.png')">
            </div>
            <span class="nome-usuario" id="nomeMini">Usuário</span>
        </div>

        <nav class="menu">
            <a href="../dashboard/tela-perfil.html">Perfil</a>
            <a href="../dashboard/tela-questoes.html">DesbravaQuiz</a>
            <a href="../dashboard/tela-desempenho.html" class="ativo">Desempenho</a>
        </nav>

        <div class="btn-sair">
            <a href="../index.html" onclick="limparSessao()">SAIR</a>
        </div>
    </aside>

    <main class="conteudo">

        <h1 class="titulo-pagina">Desempenho</h1>

        <div class="kpi-container">
            <div class="kpi">
                <h3>Última Especialidade Conquistada</h3>
                <span id="kpi1">-</span>
            </div>
            <div class="kpi">
                <h3>Total de Quizzes Jogados</h3>
                <span id="kpi2">-</span>
            </div>
            <div class="kpi">
                <h3>Média Geral de Acertos (%)</h3>
                <span id="kpi3">-</span>
            </div>
            <div class="kpi">
                <h3>Acertos do Último Quiz</h3>
                <span id="kpi4">-</span>
            </div>
        </div>

        <div class="graficos-lado">
            <div class="grafico-container">
                <h2 class="grafico-titulo">Evolução de Acertos</h2>
                <canvas id="graficoLinha"></canvas>
            </div>

            <div class="grafico-container">
                <h2 class="grafico-titulo">Quizzes Jogados</h2>
                <canvas id="graficoRosquinha"></canvas>
            </div>
        </div>

    </main>

    <script src="../js/sessao.js"></script>

</body>

</html>


<script>

    function initDesempenho() {
        carregarUsuario();
        carregarDesempenho();
    }

    function carregarUsuario() {
        const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));

        if (!usuario) {
            console.error("Usuário não encontrado no sessionStorage!");
            return;
        }

        const nomeMini = document.getElementById("nomeMini");
        const fotoMini = document.getElementById("fotoMini");

        if (nomeMini && usuario.nome) {
            nomeMini.innerText = `Olá ${usuario.nome.split(" ")[0]}!`;
        }

        const caminhoFoto = usuario.imagem_perfil
            ? `/assets/${usuario.imagem_perfil}`
            : `/assets/imgs/usuario.png`;

        fotoMini.style.backgroundImage = `url('${caminhoFoto}')`;
    }

    function salvarDadosDesempenho(ultimoQuiz, resumo, todosResultados) {
        sessionStorage.setItem("DESENVOLVIMENTO_ULTIMO_QUIZ", JSON.stringify(ultimoQuiz));
        sessionStorage.setItem("DESENVOLVIMENTO_RESUMO", JSON.stringify(resumo));
        sessionStorage.setItem("DESENVOLVIMENTO_TODOS_RESULTADOS", JSON.stringify(todosResultados));
    }

    function obterDadosDesempenho() {
        const ultimoQuiz = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_ULTIMO_QUIZ"));
        const resumo = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_RESUMO"));
        const todosResultados = JSON.parse(sessionStorage.getItem("DESENVOLVIMENTO_TODOS_RESULTADOS"));
        return { ultimoQuiz, resumo, todosResultados };
    }

    async function carregarDesempenho() {
        const usuario = JSON.parse(sessionStorage.getItem("USUARIO_DADOS"));
        if (!usuario) {
            console.error("Usuário não encontrado no sessionStorage!");
            return;
        }

        try {
            const [ultimoQuizRes, resumoRes, todosResultadosRes] = await Promise.all([
                fetch(`/dadosQuiz/ultimo/${usuario.id}`),
                fetch(`/dadosQuiz/resumo/${usuario.id}`),
                fetch(`/dadosQuiz/listar/${usuario.id}`)
            ]);

            const ultimoQuiz = await ultimoQuizRes.json();
            const resumo = await resumoRes.json();
            const todosResultados = await todosResultadosRes.json();

            salvarDadosDesempenho(ultimoQuiz, resumo, todosResultados);

            const quizzesGanhos = todosResultados.filter(q => Number(q.qtd_acertos) >= 3);

            const ultEspecialidade = quizzesGanhos.length
                ? quizzesGanhos[quizzesGanhos.length - 1].nome_especialidade
                : "-";
            document.getElementById("kpi1").innerText = ultEspecialidade;

            const totalQuizzes = todosResultados.length;
            document.getElementById("kpi2").innerText = totalQuizzes;

            const somaAcertos = todosResultados.reduce((a, b) => a + Number(b.qtd_acertos), 0);
            const somaPerguntas = todosResultados.reduce((a, b) => a + Number(b.total_perguntas), 0);
            const media = somaPerguntas > 0 ? ((somaAcertos / somaPerguntas) * 100).toFixed(1) : "0.0";
            document.getElementById("kpi3").innerText = media + "%";

            document.getElementById("kpi4").innerText = ultimoQuiz ? `${ultimoQuiz.qtd_acertos}/${ultimoQuiz.total_perguntas}` : "-";

            const ctxLinha = document.getElementById("graficoLinha").getContext("2d");
            if (window.graficoLinha instanceof Chart) window.graficoLinha.destroy();

            const coresOficiais = {
                "Ordem Unida": "#FF7F50",
                "Nós e Amarras": "#36A2EB",
                "Acampamento": "#4BC0C0"
            };

            const especialidadesJogadas = [...new Set(todosResultados.map(r => r.nome_especialidade))];

            const datasetsLinha = especialidadesJogadas.map(esp => {
                const resultadosEsp = todosResultados
                    .filter(r => r.nome_especialidade === esp)
                    .sort((a, b) => new Date(a.data_inclusao) - new Date(b.data_inclusao));

                const cor = coresOficiais[esp] || "#9966FF";

                return {
                    label: esp,
                    data: resultadosEsp.map(r => Number(r.qtd_acertos)),
                    borderColor: cor,
                    backgroundColor: 'rgba(0,0,0,0)',
                    tension: 0.4,
                    fill: false,
                    pointBackgroundColor: cor,
                    pointBorderColor: cor,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    pointStyle: 'rectRounded',
                    borderWidth: 3,
                    hoverBorderWidth: 4
                };
            });

            const maxQuizzes = Math.max(...especialidadesJogadas.map(esp =>
                todosResultados.filter(r => r.nome_especialidade === esp).length
            ));

            const labelsLinha = Array.from({ length: maxQuizzes }, (_, i) => `Quiz ${i + 1}`);

            window.graficoLinha = new Chart(ctxLinha, {
                type: 'line',
                data: { labels: labelsLinha, datasets: datasetsLinha },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff',
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                pointStyleWidth: 12
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#222',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: { weight: 'bold', size: 14 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            cornerRadius: 6,
                            boxPadding: 4
                        }
                    },
                    interaction: { mode: 'nearest', intersect: false },
                    scales: {
                        x: {
                            title: { display: true, text: "Quizzes Jogados", color: "#ffffff", font: { size: 16, weight: 'bold' } },
                            ticks: { color: '#ffffff', font: { size: 13 } },
                            grid: { color: '#444', borderDash: [3, 3] }
                        },
                        y: {
                            title: { display: true, text: "Acertos", color: "#ffffff", font: { size: 16, weight: 'bold' } },
                            ticks: { color: '#ffffff', font: { size: 13 }, stepSize: 1 },
                            grid: { color: '#444', borderDash: [3, 3] },
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });

            const ctxRosq = document.getElementById("graficoRosquinha").getContext("2d");
            if (window.graficoRosquinha instanceof Chart) window.graficoRosquinha.destroy();

            const labelsRosq = resumo.map(e => e.nome_especialidade);
            const dataRosq = resumo.map(e => Number(e.quizzes_jogados));
            const coresRosq = labelsRosq.map(e => coresOficiais[e] || "#9966FF");

            window.graficoRosquinha = new Chart(ctxRosq, {
                type: 'doughnut',
                data: {
                    labels: labelsRosq,
                    datasets: [{
                        data: dataRosq,
                        backgroundColor: coresRosq,
                        borderColor: '#121212',
                        borderWidth: 3,
                        hoverOffset: 10,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                pointStyleWidth: 14
                            }
                        },
                        tooltip: {
                            backgroundColor: '#222',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: { weight: 'bold', size: 14 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            cornerRadius: 6,
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.raw} quizzes`;
                                }
                            }
                        }
                    }
                }
            });

        } catch (erro) {
            console.error("Erro ao carregar desempenho:", erro);
        }
    }

</script>